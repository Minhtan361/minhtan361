<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch L√†m Vi·ªác</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/locale/vi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/plugin/isoWeek.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        dayjs.extend(window.dayjs_plugin_isoWeek);
        dayjs.locale('vi');
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Be Vietnam Pro"', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; }
        .admin-only { display: none !important; }
        .is-admin .admin-only { display: flex !important; }
        .is-admin .admin-cell { display: table-cell !important; }
        .name-column { position: sticky; left: 0; z-index: 20; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(8px); border-right: 2px solid #f1f5f9; }
        .shift-cell { transition: all 0.2s ease; cursor: pointer; }
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        #loader.active { opacity: 1; pointer-events: all; }
        
        /* M√†u s·∫Øc ƒë·ªông cho ca l√†m vi·ªác */
        .bg-shift-am { background-color: #f59e0b !important; color: white !important; } /* M√†u v√†ng AM */
        .bg-shift-pm { background-color: #2563eb !important; color: white !important; } /* M√†u xanh PM */
        .bg-shift-off { background-color: #f1f5f9 !important; color: #cbd5e1 !important; } /* M√†u ngh·ªâ */
    </style>
</head>
<body class="antialiased">

    <div id="loader" class="active">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <span class="text-xs font-black text-slate-500 tracking-[0.3em] uppercase">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu Cloud...</span>
    </div>

    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 px-6 py-4">
        <div class="max-w-[1440px] mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2.5 rounded-xl text-white shadow-lg shadow-blue-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                </div>
                <div>
                    <h1 class="text-xl font-black text-slate-800 leading-none">L·ªãch L√†m Vi·ªác <span class="text-blue-600">Vu√Ωp</span></h1>
                    <span id="statusLabel" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1 inline-block">‚óè Ch·∫ø ƒë·ªô xem</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="loginBtn" class="text-xs font-bold text-slate-600 bg-slate-100 px-5 py-2.5 rounded-full hover:bg-blue-50 transition">Admin Login</button>
                <button onclick="location.reload()" class="admin-only bg-red-50 text-red-500 text-xs font-bold px-4 py-2 rounded-full hover:bg-red-100 transition">Tho√°t Admin</button>
            </div>
        </div>
    </nav>

    <main class="max-w-[1440px] mx-auto p-4 md:p-8 space-y-8">
        <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4 bg-white p-2 pr-8 rounded-[24px] shadow-sm border border-slate-200">
                <div class="flex gap-1">
                    <button id="prevWeekBtn" class="p-4 hover:bg-slate-50 rounded-2xl text-slate-400 hover:text-blue-600 transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5"/></svg></button>
                    <button id="nextWeekBtn" class="p-4 hover:bg-slate-50 rounded-2xl text-slate-400 hover:text-blue-600 transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5"/></svg></button>
                </div>
                <div>
                    <h2 id="weekRange" class="text-2xl font-black text-slate-800 tracking-tight">X√°c ƒë·ªãnh tu·∫ßn...</h2>
                    <p id="weekIdDisplay" class="text-[10px] font-mono text-slate-400 uppercase tracking-widest"></p>
                </div>
            </div>
            <button id="captureBtn" class="w-full lg:w-auto bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-4 rounded-[20px] font-bold shadow-xl shadow-emerald-200 flex items-center justify-center gap-3 transition-all active:scale-95">
                Ch·ª•p n√®
            </button>
        </div>

        <div class="admin-only bg-gradient-to-r from-blue-600 to-indigo-700 p-6 rounded-[28px] shadow-xl flex flex-wrap gap-4 items-center justify-center border border-white/20">
            <h3 class="text-white font-black text-sm uppercase tracking-widest w-full text-center mb-2">Qu·∫£n L√Ω Nh√¢n S·ª± G·ªëc</h3>
            <input id="newEmpName" type="text" placeholder="T√™n nh√¢n vi√™n..." class="bg-white/10 border border-white/20 p-3.5 rounded-xl text-white placeholder:text-white/50 text-sm font-bold outline-none focus:bg-white focus:text-slate-800 transition-all w-64">
            <select id="newEmpDept" class="bg-white p-3.5 rounded-xl text-sm font-black text-slate-700 outline-none cursor-pointer">
                <option value="BEP">B·∫æP</option>
                <option value="PV_TN">PH·ª§C V·ª§ & THU NG√ÇN</option>
            </select>
            <input id="newEmpShift" type="text" placeholder="Ca m·∫∑c ƒë·ªãnh (Vd: 8h-16h)" class="bg-white/10 border border-white/20 p-3.5 rounded-xl text-white placeholder:text-white/50 text-sm font-bold outline-none focus:bg-white focus:text-slate-800 transition-all w-48">
            <button id="addEmpBtn" class="bg-white text-blue-700 px-8 py-3.5 rounded-xl font-black text-sm hover:scale-105 transition shadow-lg">L∆ØU NH√ÇN S·ª∞</button>
        </div>

        <div id="capture-area" class="bg-white p-6 md:p-10 rounded-[40px] shadow-sm border border-slate-100 overflow-hidden">
            <div class="space-y-12">
                <div>
                    <div class="flex items-center gap-3 mb-6"><div class="w-1.5 h-6 bg-orange-500 rounded-full"></div><h3 class="font-black text-slate-800 text-lg uppercase tracking-wider">B·∫øp</h3></div>
                    <div class="overflow-x-auto rounded-3xl border border-slate-100 shadow-sm">
                        <table class="w-full text-center border-collapse"><thead id="headBEP"></thead><tbody id="bodyBEP"></tbody></table>
                    </div>
                </div>
                <div>
                    <div class="flex items-center gap-3 mb-6"><div class="w-1.5 h-6 bg-blue-600 rounded-full"></div><h3 class="font-black text-slate-800 text-lg uppercase tracking-wider">Ph·ª•c V·ª• & Thu Ng√¢n</h3></div>
                    <div class="overflow-x-auto rounded-3xl border border-slate-100 shadow-sm">
                        <table class="w-full text-center border-collapse"><thead id="headPV"></thead><tbody id="bodyPV"></tbody></table>
                    </div>
                </div>
            </div>
            <div class="mt-10 pt-6 border-t border-slate-100 flex justify-between items-center text-[10px] font-bold text-slate-300 uppercase tracking-[0.3em]">
                <span>SmartSchedule Pro Cloud</span>
                <span id="timestamp"></span>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCexNUfw-tC7c4jx2HM41x1dL85DijkZiE",
            authDomain: "lichlamviec-4b977.firebaseapp.com",
            projectId: "lichlamviec-4b977",
            storageBucket: "lichlamviec-4b977.firebasestorage.app",
            messagingSenderId: "1011750021990",
            appId: "1:1011750021990:web:6aca1e42668defde9f76a7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let isAdmin = false;
        let currentWeekStart = dayjs().startOf('isoWeek');
        let currentEmployees = [];
        let masterEmployees = [];

        const holidaysVN = {
            '01/01': 'T·∫øt D∆∞∆°ng L·ªãch', '30/04': 'Gi·∫£i Ph√≥ng', '01/05': 'Qu·ªëc T·∫ø Lƒê',
            '02/09': 'Qu·ªëc Kh√°nh', '24/12': 'Gi√°ng Sinh', '25/12': 'Gi√°ng Sinh'
        };

        // H√†m x√°c ƒë·ªãnh m√†u d·ª±a tr√™n th·ªùi gian
        function getShiftColorClass(timeStr, isStatus) {
            if (!isStatus || timeStr.toUpperCase() === 'OFF') return 'bg-shift-off';
            
            // Tr√≠ch xu·∫•t s·ªë gi·ªù ƒë·∫ßu ti√™n t·ª´ chu·ªói (v√≠ d·ª• "08:00 - 16:00" l·∫•y 8)
            const hourMatch = timeStr.match(/(\d+)/);
            if (hourMatch) {
                const hour = parseInt(hourMatch[0]);
                if (hour >= 1 && hour < 13) return 'bg-shift-am'; // 1h s√°ng ƒë·∫øn 12h59 tr∆∞a
                if (hour >= 13 || hour === 0) return 'bg-shift-pm'; // 13h chi·ªÅu ƒë·∫øn ƒë√™m
            }
            return 'bg-shift-pm'; // M·∫∑c ƒë·ªãnh
        }

        async function loadMasterData() {
            const snap = await getDoc(doc(db, "settings", "master_employees"));
            masterEmployees = snap.exists() ? snap.data().list : [];
        }

        async function loadWeekData() {
            document.getElementById('loader').classList.add('active');
            await loadMasterData();
            const weekId = currentWeekStart.format('YYYY-MM-DD');
            document.getElementById('weekIdDisplay').innerText = `ID: WEEK-${weekId}`;
            renderHeaders();
            try {
                const docSnap = await getDoc(doc(db, "schedules", weekId));
                if (docSnap.exists()) {
                    currentEmployees = docSnap.data().employees;
                } else {
                    currentEmployees = masterEmployees.map(emp => ({
                        ...emp,
                        schedule: Array(7).fill({ status: true, time: emp.shiftDefault })
                    }));
                }
                renderTables();
            } catch (e) { console.error(e); } 
            finally { document.getElementById('loader').classList.remove('active'); }
        }

        async function saveCurrentData() {
            if (!isAdmin) return;
            const weekId = currentWeekStart.format('YYYY-MM-DD');
            await setDoc(doc(db, "schedules", weekId), { employees: currentEmployees });
            renderTables();
        }

        async function saveToMaster() {
            const newList = currentEmployees.map(e => ({
                id: e.id, name: e.name, dept: e.dept, shiftDefault: e.shiftDefault
            }));
            await setDoc(doc(db, "settings", "master_employees"), { list: newList });
        }

        function renderHeaders() {
            const start = currentWeekStart;
            document.getElementById('weekRange').innerText = `Tu·∫ßn ${start.format('DD/MM')} - ${start.add(6, 'day').format('DD/MM')}`;
            ['headBEP', 'headPV'].forEach(id => {
                const head = document.getElementById(id);
                let html = `<tr class="bg-slate-50"><th class="p-5 text-left name-column text-[10px] font-black text-slate-400 uppercase tracking-widest w-[200px]">Nh√¢n s·ª±</th>`;
                for(let i=0; i<7; i++) {
                    const d = start.add(i, 'day');
                    const holiday = holidaysVN[d.format('DD/MM')];
                    const isWeekend = d.day() === 0 || d.day() === 6;
                    html += `<th class="py-4 border-l border-slate-100 ${isWeekend ? 'bg-orange-50/30' : ''}">
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] font-black uppercase ${isWeekend ? 'text-orange-600' : 'text-slate-400'}">${d.format('dddd')}</span>
                            <span class="text-2xl font-black text-slate-800">${d.format('DD')}</span>
                            ${holiday ? `<span class="mt-1 px-2 py-0.5 bg-red-500 text-white text-[7px] font-bold rounded-full">${holiday}</span>` : ''}
                        </div>
                    </th>`;
                }
                html += `<th class="admin-only admin-cell p-2 bg-red-50 text-red-500 text-[10px] font-black">X√ìA</th></tr>`;
                head.innerHTML = html;
            });
        }

        function renderTables() {
            const bBep = document.getElementById('bodyBEP');
            const bPv = document.getElementById('bodyPV');
            bBep.innerHTML = ""; bPv.innerHTML = "";
            currentEmployees.forEach(emp => {
                const row = document.createElement('tr');
                row.className = "border-b border-slate-50";
                row.innerHTML = `
                    <td class="p-4 name-column text-left">
                        <div class="text-sm font-black text-slate-700">${emp.name}</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase mt-1">üïí G·ªëc: ${emp.shiftDefault}</div>
                    </td>
                    ${emp.schedule.map((d, i) => {
                        const colorClass = getShiftColorClass(d.time, d.status);
                        return `<td class="p-1.5 border-l border-slate-50">
                            <div data-action="toggle" data-uid="${emp.id}" data-day="${i}"
                                 class="shift-cell mx-auto w-full min-w-[100px] h-[55px] rounded-[15px] flex flex-col items-center justify-center shadow-sm ${colorClass}">
                                <span class="text-[14px] font-black tracking-tight">${d.time}</span>
                                <span class="text-[8px] font-bold uppercase opacity-70">${d.status ? 'L√†m vi·ªác' : 'Ngh·ªâ'}</span>
                            </div>
                        </td>`
                    }).join('')}
                    <td class="admin-only admin-cell p-2">
                        <button data-action="delete" data-uid="${emp.id}" class="text-slate-300 hover:text-red-500 font-bold">‚úï</button>
                    </td>
                `;
                if(emp.dept === 'BEP') bBep.appendChild(row); else bPv.appendChild(row);
            });
            document.body.classList.toggle('is-admin', isAdmin);
        }

        document.getElementById('prevWeekBtn').onclick = () => { currentWeekStart = currentWeekStart.subtract(1, 'week'); loadWeekData(); };
        document.getElementById('nextWeekBtn').onclick = () => { currentWeekStart = currentWeekStart.add(1, 'week'); loadWeekData(); };
        document.getElementById('loginBtn').onclick = () => {
            if (prompt("M·∫≠t kh·∫©u Admin:") === "thaithae2025@") {
                isAdmin = true;
                document.getElementById('statusLabel').innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> QU·∫¢N TR·ªä VI√äN`;
                document.getElementById('loginBtn').style.display = 'none';
                renderTables();
            }
        };

        document.getElementById('addEmpBtn').onclick = async () => {
            const name = document.getElementById('newEmpName').value;
            const dept = document.getElementById('newEmpDept').value;
            const shift = document.getElementById('newEmpShift').value || "9h-17h";
            if (!name) return;
            const newPerson = { id: Date.now(), name, dept, shiftDefault: shift, schedule: Array(7).fill({ status: true, time: shift }) };
            currentEmployees.push(newPerson);
            await saveCurrentData();
            await saveToMaster();
            document.getElementById('newEmpName').value = "";
        };

        document.getElementById('captureBtn').onclick = async () => {
            const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 2 });
            canvas.toBlob(blob => {
                navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
                alert("‚ú®");
            });
        };

        const handleAction = async (e) => {
            if(!isAdmin) return;
            const btn = e.target.closest('[data-action]');
            if(!btn) return;
            const { action, uid, day } = btn.dataset;
            const emp = currentEmployees.find(ex => ex.id == uid);
            if(action === 'delete' && confirm("X√≥a nh√¢n s·ª± n√†y?")) {
                currentEmployees = currentEmployees.filter(ex => ex.id != uid);
                await saveCurrentData(); await saveToMaster();
            } else if (action === 'toggle') {
                const dIdx = parseInt(day);
                if(emp.schedule[dIdx].status) {
                    emp.schedule[dIdx] = { status: false, time: 'OFF' };
                } else {
                    const t = prompt("Nh·∫≠p gi·ªù l√†m (Vd: 7h-15h):", emp.shiftDefault);
                    if(t) emp.schedule[dIdx] = { status: true, time: t };
                }
                await saveCurrentData();
            }
        };

        document.addEventListener('click', (e) => {
            if (e.target.closest('#bodyBEP') || e.target.closest('#bodyPV')) handleAction(e);
        });

        loadWeekData();
    </script>
</body>
</html>