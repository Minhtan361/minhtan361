<!DOCTYPE html>
<html lang="vi">
<head>
  <!-- Favicon  -->
<link rel="icon" href="https://minhtan361.github.io/minhtan361/logo/favicon.ico" type="image/x-icon">

<!-- PNG favicon nhiều kích thước -->
<link rel="icon" type="image/png" sizes="16x16" href="https://minhtan361.github.io/minhtan361/logo/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://minhtan361.github.io/minhtan361/logo/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="57x57" href="https://minhtan361.github.io/minhtan361/logo/favicon-57x57.png">
<link rel="icon" type="image/png" sizes="60x60" href="https://minhtan361.github.io/minhtan361/logo/favicon-60x60.png">
<link rel="icon" type="image/png" sizes="72x72" href="https://minhtan361.github.io/minhtan361/logo/favicon-72x72.png">
<link rel="icon" type="image/png" sizes="76x76" href="https://minhtan361.github.io/minhtan361/logo/favicon-76x76.png">
<link rel="icon" type="image/png" sizes="96x96" href="https://minhtan361.github.io/minhtan361/logo/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="114x114" href="https://minhtan361.github.io/minhtan361/logo/favicon-114x114.png">
<link rel="icon" type="image/png" sizes="120x120" href="https://minhtan361.github.io/minhtan361/logo/favicon-120x120.png">
<link rel="icon" type="image/png" sizes="144x144" href="https://minhtan361.github.io/minhtan361/logo/favicon-144x144.png">
<link rel="icon" type="image/png" sizes="152x152" href="https://minhtan361.github.io/minhtan361/logo/favicon-152x152.png">
<link rel="icon" type="image/png" sizes="180x180" href="https://minhtan361.github.io/minhtan361/logo/favicon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://minhtan361.github.io/minhtan361/logo/favicon-192x192.png">
<link rel="icon" type="image/png" sizes="256x256" href="https://minhtan361.github.io/minhtan361/logo/favicon-256x256.png">
<link rel="icon" type="image/png" sizes="384x384" href="https://minhtan361.github.io/minhtan361/logo/favicon-384x384.png">
<link rel="icon" type="image/png" sizes="512x512" href="https://minhtan361.github.io/minhtan361/logo/favicon-512x512.png">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lịch Làm by minhtan</title>
  <!-- TailwindCSS CDN (chỉ để tạo giao diện hiện đại) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Scrollbar gọn gàng */
    ::-webkit-scrollbar{height:8px;width:8px}::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:8px}
    
    /* Hiệu ứng và animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }
    
    .shift-indicator {
      position: relative;
      overflow: hidden;
    }
    
    .shift-indicator::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
    }
    
    .shift-morning::after {
      background: linear-gradient(to bottom, #fbbf24, #f59e0b);
    }
    
    .shift-evening::after {
      background: linear-gradient(to bottom, #6366f1, #4f46e5);
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .day-cell {
      transition: all 0.2s ease;
    }
    
    .day-cell:hover {
      background-color: #f0f4ff;
    }
    
    .day-cell.selected {
      background-color: #e0e7ff;
      border-color: #818cf8;
    }
    
    .pulse-alert {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
      <div class="bg-white rounded-2xl p-5 shadow-lg border border-slate-100">
        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight bg-clip-text text-transparent gradient-bg">
          <i class="fas fa-calendar-alt mr-2"></i>Đăng Ký Ca Làm by minhtan
        </h1>
        <div class="flex flex-wrap gap-3 mt-3">
          <div class="flex items-center text-sm">
            <div class="w-3 h-3 rounded-full bg-amber-400 mr-2"></div>
            <span class="text-slate-600">Buổi sáng: <b id="morning-capacity-text">2</b> người (T2→CN)</span>
          </div>
          <div class="flex items-center text-sm">
            <div class="w-3 h-3 rounded-full bg-indigo-500 mr-2"></div>
            <span class="text-slate-600">Buổi tối: <b id="evening-weekday-capacity-text">4</b> người (T2→T5), <b id="evening-weekend-capacity-text">5</b> người (T6→CN)</span>
          </div>
        </div>
      </div>
      
      <!-- Tuần -->
      <div class="bg-white rounded-2xl p-4 shadow-lg border border-slate-100">
        <div class="flex flex-col sm:flex-row items-center gap-3">
          <label class="text-sm text-slate-600 whitespace-nowrap" for="weekStart">
            <i class="far fa-calendar mr-1"></i>Tuần bắt đầu:
          </label>
          <input id="weekStart" type="date" class="px-4 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <div class="flex gap-2">
            <button id="prevWeek" class="px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm hover:bg-slate-50 transition-colors">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button id="nextWeek" class="px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm hover:bg-slate-50 transition-colors">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Thông báo -->
    <div id="toast" class="hidden mb-6 p-4 rounded-xl border-l-4 shadow-md"></div>

    <!-- Form đăng ký -->
    <section class="grid md:grid-cols-2 gap-6 mb-8">
      <form id="signupForm" class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 border border-slate-100 card-hover">
        <h2 class="font-semibold text-lg mb-4 flex items-center">
          <i class="fas fa-pen-to-square mr-2 text-indigo-500"></i>Đăng ký ca
        </h2>
        <div class="grid sm:grid-cols-2 gap-4">
          <div class="sm:col-span-2">
            <label class="text-sm text-slate-600 font-medium">Họ và tên</label>
            <div class="relative mt-1">
              <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
              <select id="empName" class="pl-10 pr-4 py-3 w-full rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <option value="">-- Chọn nhân viên --</option>
              </select>
            </div>
          </div>
          <div>
            <label class="text-sm text-slate-600 font-medium">Buổi</label>
            <div class="relative mt-1">
              <i class="fas fa-clock absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
              <select id="shift" class="pl-10 pr-4 py-3 w-full rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="sang">Sáng</option>
                <option value="toi">Tối</option>
              </select>
            </div>
          </div>
          <div class="sm:col-span-2">
            <label class="text-sm text-slate-600 font-medium">Chọn ngày (trong tuần đang xem)</label>
            <div id="dayChoices" class="mt-2 grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-2"></div>
          </div>
          <div class="sm:col-span-2">
            <label class="text-sm text-slate-600 font-medium">Ghi chú (tùy chọn)</label>
            <div class="relative mt-1">
              <i class="fas fa-sticky-note absolute left-3 top-3 transform -translate-y-1/2 text-slate-400"></i>
              <textarea id="note" placeholder="Ghi chú cho ca làm này..." class="pl-10 pr-4 py-3 w-full rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="flex items-center justify-between mt-6 pt-4 border-t border-slate-100">
          <p class="text-xs text-slate-500"><i class="fas fa-info-circle mr-1"></i>Không thể đăng ký trùng ca cùng ngày.</p>
          <button class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-md transition-colors flex items-center" type="submit">
            <i class="fas fa-check-circle mr-2"></i>Đăng ký
          </button>
        </div>
      </form>

      <!-- Khối quản trị -->
      <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 border border-slate-100 card-hover">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold text-lg flex items-center">
            <i class="fas fa-lock mr-2 text-slate-600"></i>Quản trị
          </h2>
          <div class="flex items-center gap-2">
            <div class="relative">
              <i class="fas fa-key absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
              <input id="adminPassword" type="password" placeholder="Mật khẩu admin" class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <button id="adminToggle" class="px-4 py-2.5 rounded-xl bg-slate-800 text-white hover:opacity-90 transition-colors">Đăng nhập</button>
          </div>
        </div>
        <p id="adminNote" class="mt-3 text-sm text-slate-500 bg-slate-50 p-2 rounded-lg">
          <i class="fas fa-shield-alt mr-1"></i>Chỉ admin mới xóa/chỉnh đăng ký và xuất Excel (CSV).
        </p>
        <div class="mt-4 flex items-center gap-3 pt-4 border-t border-slate-100">
          <button id="exportBtn" class="px-4 py-2.5 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-40 transition-colors flex items-center" disabled>
            <i class="fas fa-file-export mr-2"></i>Xuất Excel
          </button>
          <button id="clearWeekBtn" class="px-4 py-2.5 rounded-xl bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-40 transition-colors flex items-center pulse-alert" disabled>
            <i class="fas fa-trash mr-2"></i>Xóa tuần
          </button>
        </div>
        <div id="adminControls" class="hidden mt-4 pt-4 border-t border-slate-100">
          <h3 class="font-medium mb-3 flex items-center">
            <i class="fas fa-users-cog mr-2 text-indigo-500"></i>Quản lý nhân viên
          </h3>
          <div class="flex gap-2 mb-3">
            <input id="newEmployee" type="text" placeholder="Tên nhân viên mới" class="flex-1 px-4 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="addEmployeeBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
              <i class="fas fa-plus mr-1"></i>Thêm
            </button>
          </div>
          <div class="max-h-40 overflow-y-auto mb-4">
            <ul id="employeeList" class="space-y-1"></ul>
          </div>
          
          <h3 class="font-medium mb-3 flex items-center mt-4">
            <i class="fas fa-sliders-h mr-2 text-indigo-500"></i>Tùy chỉnh sức chứa
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-slate-600">Sáng (T2-CN)</label>
              <input id="capacityMorning" type="number" min="1" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
              <label class="text-sm text-slate-600">Tối (T2-T5)</label>
              <input id="capacityEveningWeekday" type="number" min="1" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
              <label class="text-sm text-slate-600">Tối (T6-CN)</label>
              <input id="capacityEveningWeekend" type="number" min="1" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
          </div>
          <button id="saveCapacityBtn" class="mt-3 w-full px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
            <i class="fas fa-save mr-1"></i>Lưu cài đặt
          </button>
        </div>
      </div>
    </section>

    <!-- Lịch tuần -->
    <section id="weekGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4 mb-10"></section>

    <footer class="mt-12 text-center text-xs text-slate-500 border-t border-slate-200 pt-6">
      <div class="flex items-center justify-center gap-1 mb-1">
        <i class="fas fa-calendar-check text-indigo-500"></i>
        <span>© 2025 — minhtan361</span>
      </div>
      <p>0377262912 - pls dont copy <3</p>
    </footer>
  </div>

  <!-- Firebase App + Firestore + Analytics (ESM) -->
  <script type="module">
    // ===== Firebase SDKs từ CDN =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, onSnapshot,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ===== Cấu hình Firebase của bạn =====
    const firebaseConfig = {
      apiKey: "AIzaSyCexNUfw-tC7c4jx2HM41x1dL85DijkZiE",
      authDomain: "lichlamviec-4b977.firebaseapp.com",
      projectId: "lichlamviec-4b977",
      storageBucket: "lichlamviec-4b977.firebasestorage.app",
      messagingSenderId: "1011750021990",
      appId: "1:1011750021990:web:6aca1e42668defde9f76a7",
      measurementId: "G-00HK9C9H29"
    };

    // Khởi tạo Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // ====== Cấu hình cơ bản ======
    const ADMIN_PASSWORD = 'thaithae2025@'; 

    const VN_DAYS = ['Thứ 2','Thứ 3','Thứ 4','Thứ 5','Thứ 6','Thứ 7','Chủ nhật'];

    // ====== Helpers ngày/tuần ======
    function startOfWeek(date) { // Monday as start
      const d = new Date(date);
      const day = (d.getDay() + 6) % 7; // 0=Mon..6=Sun
      d.setDate(d.getDate() - day);
      d.setHours(0,0,0,0);
      return d;
    }
    function addDays(date, days){
      const d = new Date(date);
      d.setDate(d.getDate()+days);
      return d;
    }
    function fmtISODate(date){
      return date.toISOString().slice(0,10);
    }
    function weekKeyOf(date){
      return 'week_' + fmtISODate(startOfWeek(date));
    }

    // ====== State (đồng bộ realtime) ======
    let currentWeekStart = startOfWeek(new Date());
    let isAdmin = false;

    let unsubscribeWeek = null;
    let unsubscribeEmployees = null;
    let unsubscribeCapacity = null;

    // Cache tại client
    let weekEntries = []; // mảng entries của tuần hiện tại
    let employees = [];
    let capacitySettings = { morning: 2, eveningWeekday: 4, eveningWeekend: 5 };

    // ====== DOM ======
    const weekStartInput = document.getElementById('weekStart');
    const prevWeekBtn = document.getElementById('prevWeek');
    const nextWeekBtn = document.getElementById('nextWeek');
    const dayChoices = document.getElementById('dayChoices');
    const weekGrid = document.getElementById('weekGrid');
    const signupForm = document.getElementById('signupForm');
    const empNameSelect = document.getElementById('empName');
    const shiftSelect = document.getElementById('shift');
    const noteInput = document.getElementById('note');
    const adminPasswordInput = document.getElementById('adminPassword');
    const adminToggleBtn = document.getElementById('adminToggle');
    const exportBtn = document.getElementById('exportBtn');
    const clearWeekBtn = document.getElementById('clearWeekBtn');
    const toast = document.getElementById('toast');
    const adminControls = document.getElementById('adminControls');
    const newEmployeeInput = document.getElementById('newEmployee');
    const addEmployeeBtn = document.getElementById('addEmployeeBtn');
    const employeeList = document.getElementById('employeeList');
    const capacityMorningInput = document.getElementById('capacityMorning');
    const capacityEveningWeekdayInput = document.getElementById('capacityEveningWeekday');
    const capacityEveningWeekendInput = document.getElementById('capacityEveningWeekend');
    const saveCapacityBtn = document.getElementById('saveCapacityBtn');
    const morningCapacityText = document.getElementById('morning-capacity-text');
    const eveningWeekdayCapacityText = document.getElementById('evening-weekday-capacity-text');
    const eveningWeekendCapacityText = document.getElementById('evening-weekend-capacity-text');

    // ====== UI Helpers ======
    function showToast(msg, type='ok'){
      toast.textContent = msg;
      toast.className = '';
      toast.classList.add('p-4', 'rounded-xl', 'border-l-4', 'shadow-md', 'mb-6');
      if (type === 'ok') {
        toast.classList.add('bg-emerald-50', 'text-emerald-700', 'border-emerald-400');
        toast.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i> ${msg}</div>`;
      } else {
        toast.classList.add('bg-rose-50', 'text-rose-700', 'border-rose-400');
        toast.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> ${msg}</div>`;
      }
      toast.classList.remove('hidden');
      setTimeout(()=>toast.classList.add('hidden'), 3000);
    }

    function capacityFor(dayIndex, shift) {
      if (shift === 'sang') return capacitySettings.morning || 2;
      return dayIndex <= 3 
        ? (capacitySettings.eveningWeekday || 4) 
        : (capacitySettings.eveningWeekend || 5);
    }

    function renderEmployeeDropdown() {
      empNameSelect.innerHTML = '<option value="">-- Chọn nhân viên --</option>';
      employees.forEach(employee => {
        const option = document.createElement('option');
        option.value = employee;
        option.textContent = employee;
        empNameSelect.appendChild(option);
      });
    }

    function renderEmployeeList() {
      employeeList.innerHTML = '';
      employees.forEach(employee => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between p-2 bg-slate-50 rounded-lg';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = employee;
        const delBtn = document.createElement('button');
        delBtn.className = 'px-2 py-1 text-xs bg-rose-500 text-white rounded hover:bg-rose-600';
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.addEventListener('click', async () => {
          if (!isAdmin) return;
          const updated = employees.filter(e => e !== employee);
          await setDoc(doc(db, "settings", "employees"), { list: updated }, { merge: true });
          showToast('Đã xóa nhân viên.', 'ok');
        });
        li.appendChild(nameSpan);
        li.appendChild(delBtn);
        employeeList.appendChild(li);
      });
    }

    function loadCapacityInputs() {
      capacityMorningInput.value = capacitySettings.morning || 2;
      capacityEveningWeekdayInput.value = capacitySettings.eveningWeekday || 4;
      capacityEveningWeekendInput.value = capacitySettings.eveningWeekend || 5;
      morningCapacityText.textContent = capacitySettings.morning || 2;
      eveningWeekdayCapacityText.textContent = capacitySettings.eveningWeekday || 4;
      eveningWeekendCapacityText.textContent = capacitySettings.eveningWeekend || 5;
    }

    function updateWeekInput(){
      weekStartInput.value = fmtISODate(currentWeekStart);
    }

    function renderDayChoices(){
      dayChoices.innerHTML = '';
      for (let i=0;i<7;i++){
        const d = addDays(currentWeekStart,i);
        const btn = document.createElement('button');
        btn.type='button';
        btn.dataset.dayIndex=i;
        btn.className='day-cell px-3 py-2.5 rounded-xl border border-slate-300 bg-white hover:bg-indigo-50 text-sm transition-colors';
        btn.innerHTML = `<div class="font-medium">${VN_DAYS[i].substring(0, 3)}</div><div class="text-xs text-slate-500">${d.getDate()}/${d.getMonth()+1}</div>`;
        btn.addEventListener('click',()=>{
          [...dayChoices.children].forEach(c=>c.classList.remove('selected'));
          btn.classList.add('selected');
          dayChoices.dataset.selected = i;
        });
        dayChoices.appendChild(btn);
      }
      dayChoices.children[0]?.click();
    }

    function listFor(dayIndex, shift){
      return weekEntries.filter(e=>e.dayIndex===dayIndex && e.shift===shift);
    }
    function alreadyRegistered(name, dayIndex, shift){
      const n = (name||'').trim().toLowerCase();
      return weekEntries.some(e=> e.dayIndex===dayIndex && e.shift===shift && (e.name||'').trim().toLowerCase()===n);
    }

    function renderWeekGrid(){
      weekGrid.innerHTML = '';
      for (let i=0;i<7;i++){
        const dayDate = addDays(currentWeekStart,i);
        const isToday = fmtISODate(dayDate) === fmtISODate(new Date());
        
        const col = document.createElement('div');
        col.className=`bg-white rounded-2xl shadow-lg border ${isToday ? 'border-indigo-300 ring-1 ring-indigo-200' : 'border-slate-100'} flex flex-col card-hover animate-fade-in`;

        const header = document.createElement('div');
        header.className=`px-4 py-3 border-b border-slate-100 flex items-center justify-between ${isToday ? 'bg-indigo-50' : ''}`;
        header.innerHTML = `
          <div>
            <div class="text-sm text-slate-500">${VN_DAYS[i]}</div>
            <div class="font-semibold ${isToday ? 'text-indigo-600' : ''}">${dayDate.getDate()}/${dayDate.getMonth()+1}</div>
          </div>
          ${isToday ? '<span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded-full">Hôm nay</span>' : ''}
        `;
        col.appendChild(header);

        ['sang','toi'].forEach(shift=>{
          const cap = capacityFor(i, shift);
          const items = listFor(i, shift);
          const remain = cap - items.length;
          const isFull = remain <= 0;

          const wrap = document.createElement('div');
          wrap.className=`p-4 border-b border-slate-100 last:border-b-0 shift-indicator ${shift === 'sang' ? 'shift-morning' : 'shift-evening'}`;

          const title = document.createElement('div');
          title.className='flex items-center justify-between mb-3';
          title.innerHTML = `
            <div class="font-medium flex items-center">
              ${shift==='sang' ? '<i class="fas fa-sun text-amber-500 mr-2"></i>' : '<i class="fas fa-moon text-indigo-500 mr-2"></i>'}
              ${shift==='sang'?'Buổi sáng':'Buổi tối'} 
              <span class="text-xs text-slate-500 ml-1">(Tối đa ${cap})</span>
            </div>
            <div class="text-xs font-medium ${isFull ? 'text-rose-600 bg-rose-50 px-2 py-1 rounded-full' : 'text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full'}">
              ${isFull ? 'Đã đủ' : `Còn ${remain}`}
            </div>
          `;
          wrap.appendChild(title);

          const list = document.createElement('div');
          list.className='flex flex-col gap-2';

          if (items.length===0){
            const empty = document.createElement('div');
            empty.className='text-sm text-slate-400 italic text-center py-2';
            empty.innerHTML = '<i class="far fa-frown mr-1"></i> Chưa có ai đăng ký';
            list.appendChild(empty);
          } else {
            items
              .slice()
              .sort((a,b)=> a.createdAt.localeCompare(b.createdAt))
              .forEach((e)=>{
                const row = document.createElement('div');
                row.className='group flex items-center justify-between px-3 py-2 bg-slate-50 rounded-xl transition-colors hover:bg-slate-100';
                
                const info = document.createElement('div');
                info.className='flex-1';
                
                const name = document.createElement('div');
                name.className='text-sm font-medium truncate';
                name.textContent = e.name;
                
                if (e.note) {
                  const note = document.createElement('div');
                  note.className='text-xs text-slate-500 truncate';
                  note.textContent = e.note;
                  info.appendChild(name);
                  info.appendChild(note);
                } else {
                  info.appendChild(name);
                }
                
                const right = document.createElement('div');
                right.className='flex items-center gap-2 text-xs text-slate-500';
                const time = new Date(e.createdAt);
                right.innerHTML = `<span>${time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;

                if (isAdmin){
                  const delBtn = document.createElement('button');
                  delBtn.title='Xóa đăng ký';
                  delBtn.className='opacity-0 group-hover:opacity-100 px-2 py-1 rounded-lg bg-rose-500 text-white text-xs hover:bg-rose-600 transition-opacity';
                  delBtn.innerHTML = '<i class="fas fa-times"></i>';
                  delBtn.addEventListener('click', async ()=>{
                    // Xóa entry bằng transaction để tránh race
                    const key = weekKeyOf(currentWeekStart);
                    const ref = doc(db, "weeks", key);
                    try {
                      await runTransaction(db, async (tx) => {
                        const snap = await tx.get(ref);
                        const cur = snap.exists() ? (snap.data().entries || []) : [];
                        const keep = cur.filter(x => !(x.dayIndex===e.dayIndex && x.shift===e.shift && x.name===e.name && x.createdAt===e.createdAt));
                        tx.set(ref, { entries: keep }, { merge: true });
                      });
                      showToast('Đã xóa đăng ký.', 'ok');
                    } catch (err) {
                      console.error(err);
                      showToast('Lỗi khi xóa đăng ký.', 'err');
                    }
                  });
                  right.appendChild(delBtn);
                }

                row.appendChild(info);
                row.appendChild(right);
                list.appendChild(row);
              });
          }

          wrap.appendChild(list);
          col.appendChild(wrap);
        });

        weekGrid.appendChild(col);
      }
    }

    // ====== Firestore realtime subscriptions ======
    function subscribeEmployees() {
      if (unsubscribeEmployees) unsubscribeEmployees();
      const ref = doc(db, "settings", "employees");
      unsubscribeEmployees = onSnapshot(ref, (snap)=>{
        employees = snap.exists() ? (snap.data().list || []) : [];
        renderEmployeeDropdown();
        if (isAdmin) renderEmployeeList();
      });
    }

    function subscribeCapacity() {
      if (unsubscribeCapacity) unsubscribeCapacity();
      const ref = doc(db, "settings", "capacity");
      unsubscribeCapacity = onSnapshot(ref, (snap)=>{
        capacitySettings = snap.exists() ? snap.data() : { morning:2, eveningWeekday:4, eveningWeekend:5 };
        loadCapacityInputs();
        renderWeekGrid();
      });
    }

    function subscribeWeek(date) {
      if (unsubscribeWeek) unsubscribeWeek();
      const key = weekKeyOf(date);
      const ref = doc(db, "weeks", key);
      unsubscribeWeek = onSnapshot(ref, (snap)=>{
        weekEntries = snap.exists() ? (snap.data().entries || []) : [];
        renderWeekGrid();
      });
    }

    // ====== Sự kiện ======
    weekStartInput.addEventListener('change', (e)=>{
      const d = new Date(e.target.value);
      currentWeekStart = startOfWeek(d);
      updateWeekInput();
      renderDayChoices();
      subscribeWeek(currentWeekStart);
    });
    prevWeekBtn.addEventListener('click', ()=>{
      currentWeekStart = addDays(currentWeekStart, -7);
      updateWeekInput();
      renderDayChoices();
      subscribeWeek(currentWeekStart);
    });
    nextWeekBtn.addEventListener('click', ()=>{
      currentWeekStart = addDays(currentWeekStart, 7);
      updateWeekInput();
      renderDayChoices();
      subscribeWeek(currentWeekStart);
    });

    signupForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = (empNameSelect.value||'').trim();
      if (!name){ showToast('Vui lòng chọn nhân viên.', 'err'); return; }
      const shift = shiftSelect.value; // 'sang' | 'toi'
      const dayIndex = parseInt(dayChoices.dataset.selected || '0');
      const note = (noteInput.value||'').trim();

      // Kiểm tra trùng & còn slot dựa trên cache hiện tại
      if (alreadyRegistered(name, dayIndex, shift)){
        showToast('Nhân viên đã đăng ký ca này rồi.', 'err');
        return;
      }
      const cap = capacityFor(dayIndex, shift);
      const current = listFor(dayIndex, shift);
      if (current.length >= cap){
        showToast('Ca đã đủ số lượng.', 'err');
        return;
      }

      const entry = { name, shift, dayIndex, note, createdAt: new Date().toISOString() };
      const key = weekKeyOf(currentWeekStart);
      const ref = doc(db, "weeks", key);

      try {
        // Transaction để đảm bảo tính đúng đắn khi nhiều người cùng ghi
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(ref);
          const list = snap.exists() ? (snap.data().entries || []) : [];
          // Kiểm tra lại trong transaction
          const duplicate = list.some(e => e.dayIndex===dayIndex && e.shift===shift && (e.name||'').trim().toLowerCase()===name.toLowerCase());
          if (duplicate) throw new Error('DUPLICATE');
          const count = list.filter(e => e.dayIndex===dayIndex && e.shift===shift).length;
          if (count >= capacityFor(dayIndex, shift)) throw new Error('FULL');
          list.push(entry);
          tx.set(ref, { entries: list }, { merge: true });
        });

        showToast('Đăng ký thành công!', 'ok');
        noteInput.value = '';
      } catch (err) {
        if (err && err.message === 'DUPLICATE') {
          showToast('Nhân viên đã đăng ký ca này rồi.', 'err');
        } else if (err && err.message === 'FULL') {
          showToast('Ca đã đủ số lượng.', 'err');
        } else {
          console.error(err);
          showToast('Lỗi khi đăng ký. Vui lòng thử lại.', 'err');
        }
      }
    });

    adminToggleBtn.addEventListener('click', ()=>{
      if (!isAdmin){
        if (adminPasswordInput.value === ADMIN_PASSWORD){
          isAdmin = true;
          adminToggleBtn.textContent = 'Đăng xuất';
          adminToggleBtn.classList.add('bg-indigo-600');
          exportBtn.disabled = false;
          clearWeekBtn.disabled = false;
          adminControls.classList.remove('hidden');
          showToast('Đăng nhập admin thành công.', 'ok');
          renderWeekGrid();
          renderEmployeeList();
          loadCapacityInputs();
        } else {
          showToast('Sai mật khẩu admin.', 'err');
        }
      } else {
        isAdmin = false;
        adminToggleBtn.textContent = 'Đăng nhập';
        adminToggleBtn.classList.remove('bg-indigo-600');
        exportBtn.disabled = true;
        clearWeekBtn.disabled = true;
        adminControls.classList.add('hidden');
        showToast('Đã đăng xuất admin.', 'ok');
        renderWeekGrid();
      }
    });

    addEmployeeBtn.addEventListener('click', async () => {
      const name = newEmployeeInput.value.trim();
      if (!name) { showToast('Vui lòng nhập tên nhân viên.', 'err'); return; }
      if (!isAdmin) { showToast('Chỉ admin mới thêm nhân viên.', 'err'); return; }

      const setRef = doc(db, "settings", "employees");
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(setRef);
          const list = snap.exists() ? (snap.data().list || []) : [];
          if (list.includes(name)) throw new Error('EXIST');
          list.push(name);
          tx.set(setRef, { list }, { merge: true });
        });
        newEmployeeInput.value = '';
        showToast('Đã thêm nhân viên mới.', 'ok');
      } catch (err) {
        if (err.message === 'EXIST') showToast('Nhân viên đã tồn tại.', 'err');
        else { console.error(err); showToast('Lỗi khi thêm nhân viên.', 'err'); }
      }
    });

    saveCapacityBtn.addEventListener('click', async () => {
      if (!isAdmin) { showToast('Chỉ admin mới chỉnh sức chứa.', 'err'); return; }
      const morning = parseInt(capacityMorningInput.value) || 2;
      const eveningWeekday = parseInt(capacityEveningWeekdayInput.value) || 4;
      const eveningWeekend = parseInt(capacityEveningWeekendInput.value) || 5;
      if (morning < 1 || eveningWeekday < 1 || eveningWeekend < 1) {
        showToast('Sức chứa phải lớn hơn 0.', 'err');
        return;
      }
      try {
        await setDoc(doc(db, "settings", "capacity"), { morning, eveningWeekday, eveningWeekend }, { merge: true });
        showToast('Đã lưu cài đặt sức chứa.', 'ok');
      } catch (err) {
        console.error(err);
        showToast('Lỗi khi lưu sức chứa.', 'err');
      }
    });

    exportBtn.addEventListener('click', ()=>{
      if (!isAdmin) return;
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      csvContent += "LỊCH LÀM VIỆC - TUẦN BẮT ĐẦU " + fmtISODate(currentWeekStart) + "\r\n\r\n";
      csvContent += "Ngày,Buổi,Họ tên,Ghi chú,Giờ đăng ký\r\n";
      const data = weekEntries.slice().sort((a,b)=> a.dayIndex-b.dayIndex || a.shift.localeCompare(b.shift) || a.createdAt.localeCompare(b.createdAt));
      data.forEach(entry=>{
        const dayDate = addDays(currentWeekStart, entry.dayIndex);
        const dateStr = `${dayDate.getDate()}/${dayDate.getMonth()+1}/${dayDate.getFullYear()}`;
        const shiftName = entry.shift === 'sang' ? 'Sáng' : 'Tối';
        const time = new Date(entry.createdAt);
        const timeStr = time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) + ' ' + time.toLocaleDateString();
        const escapeCSV = (str) => {
          if (!str) return '';
          if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return '"' + str.replace(/"/g, '""') + '"';
          }
          return str;
        };
        csvContent += `${escapeCSV(dateStr)},${escapeCSV(shiftName)},${escapeCSV(entry.name)},${escapeCSV(entry.note)},${escapeCSV(timeStr)}\r\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `LichLamViec_${fmtISODate(currentWeekStart)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showToast('Đã xuất file Excel (CSV).', 'ok');
    });

    clearWeekBtn.addEventListener('click', async ()=>{
      if (!isAdmin) return;
      if (!confirm('Xóa tất cả đăng ký trong tuần này? Không thể hoàn tác.')) return;
      const key = weekKeyOf(currentWeekStart);
      try {
        await setDoc(doc(db, "weeks", key), { entries: [] }, { merge: true });
        showToast('Đã xóa toàn bộ đăng ký tuần.', 'ok');
      } catch (err) {
        console.error(err);
        showToast('Lỗi khi xóa tuần.', 'err');
      }
    });

    // ====== Khởi tạo ======
    function init(){
      currentWeekStart = startOfWeek(new Date());
      updateWeekInput();
      renderDayChoices();
      subscribeWeek(currentWeekStart);
      subscribeEmployees();
      subscribeCapacity();
    }
    init();
  </script>
</body>
</html>

